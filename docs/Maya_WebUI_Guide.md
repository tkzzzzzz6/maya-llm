# 🦆 麻鸭语音助手 Web UI 使用指南

## 📖 简介

**麻鸭语音助手** 是一个基于麻鸭语料微调的智能语音助手系统，提供现代化的 Web 交互界面。

### ✨ 核心特性

| 功能 | 技术栈 | 说明 |
|------|--------|------|
| 🎙️ 语音识别 | SenseVoice | 高精度中英文识别 |
| 🔑 关键词唤醒 | 拼音匹配 | 自定义唤醒词保护隐私 |
| 👤 声纹识别 | CAM++ | 声纹验证专属助手 |
| 🤖 智能对话 | Qwen2.5-1.5B | 上下文记忆对话 |
| 🔊 语音合成 | Edge TTS | 多语种自然语音 |
| 💾 对话记忆 | 自研 | 支持多轮对话 |

---

## 🚀 快速开始

### 方法1：一键启动（推荐）

**Windows 用户：**
```bash
# 双击运行
start_maya_webui.bat
```

**Linux/Mac 用户：**
```bash
# 添加执行权限
chmod +x start_maya_webui.sh

# 运行
./start_maya_webui.sh
```

### 方法2：命令行启动

```bash
# 基础启动
python maya_webui.py

# 指定端口
python maya_webui.py --port 8080

# 生成公网访问链接（可分享给他人）
python maya_webui.py --share

# 指定服务器地址
python maya_webui.py --server-name 0.0.0.0 --port 7860
```

---

## 📋 使用流程

### 第 1 步：加载模型

1. 浏览器访问 `http://localhost:7860`
2. 点击 **"📦 1. 模型加载"** 标签页
3. 点击 **"🚀 加载所有模型"** 按钮
4. 等待 1-3 分钟（首次需要下载）

**模型列表：**
- ✅ SenseVoiceSmall (语音识别) - 约 300MB
- ✅ CAM++ (声纹识别) - 约 100MB  
- ✅ Qwen2.5-1.5B-Instruct (对话) - 约 3GB

### 第 2 步：声纹注册（可选）

如果需要声纹验证功能：

1. 点击 **"👤 2. 声纹注册"** 标签页
2. 点击麦克风录制 **3-10秒** 清晰语音
   - 建议说："你好，我是[你的名字]，这是我的声纹"
3. 点击 **"✅ 注册声纹"**
4. 看到 "✅ 声纹注册成功" 即可

### 第 3 步：开始对话

1. 点击 **"💬 3. 开始对话"** 标签页

#### 文字对话方式：
- 在"文字输入"框输入："yaya，今天天气怎么样？"
- 点击 **"🚀 发送"**

#### 语音对话方式：
- 点击麦克风图标录音
- 说："yaya，今天天气怎么样？"
- 点击 **"🚀 发送"**

⚠️ **重要**：必须包含唤醒词（默认"yaya"）才会响应！

---

## ⚙️ 高级设置

在"开始对话"页面展开 **"⚙️ 高级设置"**：

### 1. 关键词唤醒

```
☑ 启用关键词唤醒
唤醒词: yaya
```

**自定义唤醒词：**
- 支持任何中文短语
- 建议 2-4 个字
- 示例："小千"、"你好"、"麻鸭助手"

**使用场景：**
- ✅ 启用：保护隐私，避免误触发
- ❌ 禁用：纯文字快速对话

### 2. 声纹验证

```
☑ 启用声纹验证
声纹相似度阈值: 0.35
```

**阈值说明：**
- `0.1-0.2`：非常宽松（容易通过）
- `0.3-0.4`：推荐值（平衡）
- `0.5-0.9`：严格（难通过）

**使用场景：**
- ✅ 启用：专属助手，仅注册用户可用
- ❌ 禁用：任何人都可以使用

### 3. 语音合成

```
☑ 启用语音合成
```

**使用场景：**
- ✅ 启用：听语音回复（推荐）
- ❌ 禁用：仅看文字（公共场合）

### 4. 系统提示词

```
你叫小千，是一个18岁的女大学生，性格活泼开朗，
说话俏皮简洁，回答问题不会超过50字。
```

**自定义人设：**

专业助手：
```
你是一名专业的AI助手，擅长解答各类问题，
回答准确、简洁、专业。
```

幽默助手：
```
你是一个幽默风趣的助手，喜欢用轻松有趣的方式
回答问题，经常用emoji和比喻。
```

技术专家：
```
你是一名资深软件工程师，擅长Python、AI、Web开发，
回答时会给出代码示例和最佳实践。
```

---

## 🎯 使用场景

### 场景 1：纯文字快速问答

**配置：**
```
☐ 启用关键词唤醒  （关闭）
☐ 启用声纹验证    （关闭）
☑ 启用语音合成    （可选）
```

**使用：**
- 直接输入问题，无需唤醒词
- 快速获得回答

---

### 场景 2：语音助手（推荐）

**配置：**
```
☑ 启用关键词唤醒  （开启）
唤醒词: yaya

☐ 启用声纹验证    （关闭）
☑ 启用语音合成    （开启）
```

**使用：**
1. 录制语音："yaya，明天天气怎么样？"
2. 点击发送
3. 收到语音+文字回复

---

### 场景 3：专属私人助手

**配置：**
```
☑ 启用关键词唤醒  （开启）
唤醒词: 小千

☑ 启用声纹验证    （开启）
阈值: 0.35

☑ 启用语音合成    （开启）
```

**使用：**
1. 先在"声纹注册"页面注册声纹
2. 录制语音："小千，帮我查一下..."
3. 系统验证声纹后回复

---

## 🔧 功能测试

在 **"🔧 4. 功能测试"** 页面可以单独测试：

### 测试语音识别
1. 录制测试音频
2. 点击"识别"
3. 查看识别结果

### 测试声纹验证
1. 确保已注册声纹
2. 录制测试音频
3. 调整阈值
4. 点击"验证"
5. 查看相似度分数

---

## 💡 使用技巧

### 1. 提高识别准确率

✅ **推荐做法：**
- 安静环境录音
- 清晰发音，不要太快
- 距离麦克风 10-30cm
- 使用外置麦克风（比内置好）

❌ **避免：**
- 嘈杂环境
- 背景音乐
- 口齿不清
- 音量过小

### 2. 唤醒词设计

✅ **好的唤醒词：**
- "小千" - 简短清晰
- "麻鸭助手" - 独特不易误触发
- "你好助手" - 礼貌自然

❌ **不好的唤醒词：**
- "啊" - 太短，容易误触发
- "帮我查一下天气" - 太长
- "Hello" - 英文拼音不准确

### 3. 对话技巧

**多轮对话：**
```
用户: yaya，北京今天天气怎么样？
助手: 北京今天晴，温度20-28度。

用户: yaya，那明天呢？
助手: 明天多云，温度19-26度。（记住了"北京"）
```

**清空记忆：**
- 点击 **"🗑️ 清空历史"** 重置对话
- 适合切换话题时使用

### 4. 性能优化

**如果响应慢：**
1. 关闭不必要的功能（声纹、TTS）
2. 减少系统提示词长度
3. 使用更小的模型（修改代码）

**如果内存不足：**
- 关闭其他程序
- 使用 CPU 推理（修改代码中的 device_map）

---

## ⚠️ 常见问题

### Q1: 模型加载失败

**错误信息：**
```
❌ 模型加载失败: Connection timeout
```

**解决方案：**
1. 检查网络连接
2. 重试几次
3. 设置代理（如果在国外）
4. 手动下载模型（参考 README）

---

### Q2: 唤醒词不生效

**现象：**
说了唤醒词，但提示"未检测到唤醒词"

**原因：**
拼音匹配失败

**解决方案：**
```python
# 测试唤醒词拼音
唤醒词: "yaya"
拼音: "zhan qi lai"

# 你的输入
"yaya帮我查天气"
拼音: "zhan qi lai bang wo cha tian qi"
→ 包含 "zhanqilai" → ✅ 通过

# 如果不通过
试试其他唤醒词："小千"、"你好"
```

---

### Q3: 声纹验证总是失败

**现象：**
总是提示"声纹验证失败"

**解决方案：**
1. **降低阈值**: 从 0.35 降到 0.25
2. **重新注册**: 录制更清晰的声纹（5-10秒）
3. **环境一致**: 注册和使用时用同样的麦克风
4. **测试验证**: 在"功能测试"页面调整阈值找最佳值

---

### Q4: 没有麦克风怎么办

**解决方案：**
1. **文字输入**: 直接打字对话
2. **上传音频**: 点击"上传"按钮，选择音频文件
3. **手机录音**: 用手机录音后传到电脑上传

---

### Q5: 响应速度慢

**优化方案：**

**方案1：关闭不必要功能**
```
☐ 启用关键词唤醒
☐ 启用声纹验证  
☐ 启用语音合成  （最耗时）
```

**方案2：使用 GPU**
- 确保安装了 CUDA
- 代码会自动使用 GPU 加速

**方案3：减少生成长度**
修改系统提示词：
```
你是AI助手，回答控制在20字以内。
```

---

### Q6: 生成公网链接失败

**命令：**
```bash
python maya_webui.py --share
```

**错误：**
```
Could not create share link
```

**解决方案：**
1. 检查网络（需要访问 gradio.app）
2. 使用内网穿透工具（ngrok、frp）
3. 部署到云服务器

---

## 📊 界面布局

```
┌─────────────────────────────────────┐
│      🦆 麻鸭语音助手 Web UI        │
├─────────────────────────────────────┤
│                                     │
│  [📦 1.模型加载] [👤 2.声纹注册]  │
│  [💬 3.开始对话] [🔧 4.功能测试]  │
│  [📖 使用说明]                      │
│                                     │
├─────────────────────────────────────┤
│  输入区              │   输出区     │
│  ├─ 文字输入         │   ├─ 文字回复│
│  ├─ 语音输入         │   ├─ 语音回复│
│  ├─ 高级设置         │   └─ 对话历史│
│  │  ├─ 唤醒词       │              │
│  │  ├─ 声纹验证     │              │
│  │  └─ 系统提示     │              │
│  └─ [发送] [清空]    │              │
└─────────────────────────────────────┘
```

---

## 🎨 自定义界面

### 修改主题颜色

编辑 `maya_webui.py` 中的 CSS：

```python
custom_css = """
.header-title {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    /* 修改为你喜欢的渐变色 */
}
"""
```

**推荐配色：**
- 蓝紫渐变：`#667eea` → `#764ba2` (默认)
- 橙红渐变：`#f093fb` → `#f5576c`
- 绿蓝渐变：`#4facfe` → `#00f2fe`
- 粉紫渐变：`#a8edea` → `#fed6e3`

### 修改标题

```python
gr.HTML("""
<div class="header-title">🦆 麻鸭语音助手</div>
<div class="header-subtitle">你的自定义副标题</div>
""")
```

---

## 🔒 安全建议

### 公网部署注意事项

❌ **不推荐：**
```bash
# 直接暴露到公网（危险）
python maya_webui.py --server-name 0.0.0.0 --share
```

✅ **推荐：**
1. **添加身份验证**（Gradio 自带）
2. **使用 HTTPS**
3. **限制访问IP**
4. **部署在内网**，通过 VPN 访问

### 声纹文件保护

声纹文件保存在：
```
./SpeakerVerification_DIR/enroll_wav/enroll_0.wav
```

**建议：**
- 定期备份
- 设置文件权限（Linux: `chmod 600`）
- 不要分享给他人

---

## 📈 性能指标

### 系统要求

| 配置 | 最低要求 | 推荐配置 |
|------|----------|---------|
| CPU | 4核心 | 8核心+ |
| 内存 | 8GB | 16GB+ |
| GPU | 无 | NVIDIA 4GB+ |
| 磁盘 | 10GB | 20GB+ |
| 网络 | 10Mbps | 100Mbps+ |

### 响应时间

| 功能 | CPU | GPU |
|------|-----|-----|
| 语音识别 | ~2s | ~0.5s |
| 声纹验证 | ~1s | ~0.3s |
| 大模型推理 | ~5-10s | ~1-2s |
| 语音合成 | ~2s | ~2s |
| **总计** | ~10-15s | ~4-6s |

---

## 🛠️ 故障排除

### 日志查看

终端会显示详细日志：
```
✅ 所有模型加载成功！
检测到唤醒词: yaya
✅ 声纹验证通过 (相似度: 0.67)
检测到语种：zh，使用音色：zh-CN-XiaoyiNeural
```

### 调试模式

修改代码启用详细日志：
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

---

## 📞 获取帮助

### 文档
- 项目 README: `README.md`
- API 文档: `docs/API_Guide.md`
- 部署指南: `docs/Deployment_Guide.md`

### 社区
- GitHub Issues
- 技术交流群

---

## 🎉 总结

**麻鸭语音助手 Web UI** 提供了：
- ✅ 现代化的交互界面
- ✅ 完整的语音助手功能
- ✅ 灵活的配置选项
- ✅ 详细的使用文档

**开始使用：**
```bash
python maya_webui.py
```

🦆 **祝您使用愉快！**

